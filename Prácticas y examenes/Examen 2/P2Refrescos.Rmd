---
title: "P2Refrescos"
author: "Daniel Sibaja Salazar"
date: "2024-06-01"
output: html_document
---

# Datos

```{r}
load("refrescos.Rdata")
str(base)
base$carbonatacion=as.factor(base$carbonatacion)
base$presion=as.factor(base$presion)
base$rapidez=as.factor(base$rapidez)
```

# 1 

## Interacciones dobles.  

```{r}
library(ggplot2)

ggplot(base,aes(x=presion,y=d2,group = rapidez))+ stat_summary(fun = "mean",geom = "line",aes(linetype = rapidez))
ggplot(base,aes(x=presion,y=d2,group = carbonatacion))+ stat_summary(fun = "mean",geom = "line",aes(linetype = carbonatacion))
ggplot(base,aes(x=rapidez,y=d2,group = carbonatacion))+ stat_summary(fun = "mean",geom = "line",aes(linetype = carbonatacion))

```

## Decidir 

No se espera interacción entre presión y rapidez, pero si entre presión y carbonatación y rapidez y carbonatación

## Efectos

?? Esto me cuesta un poco. Preguntar si los ejes están bien.

1. Presión tiene un efecto de +- 1.2 según si tenemos presion 30 o 25
2. Rapidez el efecto es parecido, aprox +-1.2

# 2 Aov con carb y presion

```{r}
mod0=aov(d2~presion*carbonatacion,data = base)
```

## Efectos 

```{r}
model.tables(mod0)
```

## A mano 

```{r}
mg=mean(base$d2);mg
mp=tapply(base$d2,base$presion,mean);mp
mc=tapply(base$d2,base$carbonatacion,mean);mc
ai=mp-mg;ai
ci=mc-mg;ci
```

Son iguales. 

## Efectos de interacción 

```{r}
m=tapply(base$d2,list(base$presion,base$carbonatacion),mean);m

m11=mg+ai[1]+ci[1]
m12=mg+ai[1]+ci[2]
m13=mg+ai[1]+ci[3]
m21=mg+ai[2]+ci[1]
m22=mg+ai[2]+ci[2]
m23=mg+ai[2]+ci[3]

msi=matrix(c(m11,m12,m13,m21,m22,m23),nrow = 2,ncol = 3,byrow = T)

int1=m-msi;int1

```

## CMPresion

```{r}
table(base$presion)
r=12
scpresion=sum(r*(mp-mg)^2);scpresion
cmpresion=scpresion/(2-1);cmpresion

```

##  CMCarbonatacion 

```{r}
table(base$carbonatacion)
r=8
sccarb=sum(r*(mc-mg)^2);sccarb
cmcarb=sccarb/(3-1);cmcarb

```

## Que representa

La variabilidad dentro de los niveles de dicho factor. 


## CMInt

```{r}
table(base$carbonatacion,base$presion)
r=4
scint=sum(4*int1^2);scint
cmint=scint/((2-1)*(3-1));cmint
```

## CMRes 

```{r}
vt=tapply(base$d2,list(base$presion,base$carbonatacion),var)
4*vt
r=4
scres=sum(sum((r-1)*vt));scres
cmres=scres/(nrow(base)-6);cmres

```

## Compare 

```{r}
anova(mod0)
```

Todos dan igual. 

## Hipótesis de interacción 

$$
H0:(\alpha \delta)_{ij}=0
$$


## Prueba de interacción 

```{r}
f=cmint/cmres
pf(f,(2-1)*(3-1),nrow(base)-6,lower.tail = F)
```

Existe interacción en carbonatación y presion 

## Estime promedios 

```{r}

mg+ai[1]+ci[1]+int1[1,1]
mg+ai[1]+ci[2]+int1[1,2]
mg+ai[1]+ci[3]+int1[1,3]
mg+ai[2]+ci[1]+int1[2,1]
mg+ai[2]+ci[2]+int1[2,2]
mg+ai[2]+ci[3]+int1[2,3]

```

También se puede hacer con los vectores. 

## Construya los contrastes adecuados 

Acá solo podemos hacer inferencia para cada nivel de presion con un nivel fijado de carbonatacion 

Para carb1

mu11=mu21

mu12=mu22

mu13=mu23

Los contrastes 

mu11-mu21

mu12-mu22

mu13-mu23

```{r}
options(contrasts = c("contr.sum","contr.poly"))
mod1=aov(d2~presion*carbonatacion,data = base)
coef=coef(mod1);coef
```

Los vectores para las medias 

```{r}
coef

v1=c(1,1,1,0,1,0)
v2=c(1,-1,1,0,-1,0)
h1=v1-v2

v3=c(1,1,0,1,0,1)
v4=c(1,-1,0,1,0,-1)
h2=v4-v3

v5=c(1,1,-1,-1,-1,-1)
v6=c(1,-1,-1,-1,1,1)
h3=v6-v5

l1=h1%*%coef
l2=h2%*%coef
l3=h3%*%coef


```
Preguntar aquí con qué se verifica ortogonalidad
Sobre todo cuando hay interacción 


Se hacen las pruebas de hipótesis 

Necesito el error estándar

```{r}
ee=sqrt(t(h1)%*%vcov(mod1)%*%h1);ee
```

Y las t

```{r}
t1=l1/ee
t2=l2/ee
t3=l3/ee
t1;t2;t3
```

Y las probabildades asociadas 

```{r}
pt(t1,nrow(base)-6,lower.tail = F)
pt(t2,nrow(base)-6,lower.tail = F)
pt(t3,nrow(base)-6,lower.tail = F)
```

Se encuentran diferencias en el nivel dos de carbontación y el nivel 3. 


## Intervalos 

Necesito un cuantil de la t

```{r}
qt=qt(1-0.025,18,lower.tail = T)
```
Y se hacen los intervalos 

```{r}
l2-qt*ee;l2+qt*ee
l3-qt*ee;l3+qt*ee

```

### Borrar Enviroment para que a la hora de seguir no confundir objetos. 

```{r}
rm(list = ls())
load("refrescos.Rdata")
base$carbonatacion=as.factor(base$carbonatacion)
base$presion=as.factor(base$presion)
base$rapidez=as.factor(base$rapidez)
```

# Solo carbonatación y rapidez 

```{r}
mod2=aov(d2~rapidez*carbonatacion,data = base)
```


## Efectos simples

```{r}
model.tables(mod2)
```

## A mano

```{r}
mr=tapply(base$d2,base$rapidez,mean)
mr
mc=tapply(base$d2,base$carbonatacion,mean)
mc
mg=mean(base$d2);mg

ai=mr-mg;ai
ci=mc-mg;ci
```

Son iguales a los de la tabla 

## Efectos de interacción 

```{r}
m=tapply(base$d2,list(base$rapidez,base$carbonatacion),mean)

int2=c(m[1,1]-(mg+ai[1]+ci[1]),m[1,2]-(mg+ai[1]+ci[2]),m[1,3]-(mg+ai[1]+ci[3]),m[2,1]-(mg+ai[2]+ci[1]),m[2,2]-(mg+ai[2]+ci[2]),m[2,3]-(mg+ai[2]+ci[3]))

int2
```

Son iguales a los de la tabla


## CMRap

```{r}
table(base$rapidez)
r=12
scrap=sum(r*(mr-mg)^2);scrap
cmrap=scrap/1;cmrap
```

## CMInt

```{r}
r=4
scint=sum(r*int2^2);scint
glint=(2-1)*(3-1)
cmint=scint/glint;cmint
```

## CMRes

```{r}
v=tapply(base$d2,list(base$rapidez,base$carbonatacion),var)
mean(v)
r=4
cmres=sum((4-1)*v)/18


```


Este valor representa la variabilidad dentro de los tratamientos 

## Compare con ANOVA

```{r}
anova(mod2)
```

Dan igual 

## Hipótesis de interacción 

H0: (ab)ij=0

Los efectos de la interacción son 0 

## Prueba de hipótesis 

```{r}
f=cmint/cmres
pf(f,2,18,lower.tail = F)
```

No hay interacción 

## Cambiar modelo 

```{r}
options(contrasts = c("contr.sum","contr.poly"))
mod3=lm(d2~rapidez+carbonatacion,data = base)
```

## Est Promedio por tratamiento 

```{r}
m
m11=mg+ai[1]+ci[1]
m12=mg+ai[1]+ci[2]
m13=mg+ai[1]+ci[3]

m21=mg+ai[2]+ci[1]
m22=mg+ai[2]+ci[2]
m23=mg+ai[2]+ci[3]

mest=matrix(c(m11,m12,m13,m21,m22,m23),nrow = 2,ncol = 3,byrow = T)
mest
```

## Represente 

Estos promedios son diferentes pues en uno se toma en cuenta los efectos de la interacción y otros no

## CMRes del nuevo modelo 

```{r}
anova(mod3)
mean(v)
```

No coincide porque para calcular las varianzas se toman en cuenta los efectos de la interacción en el calculo de los promedios, el cual es necesario para calcular las varianzas. 

## Hipotesis del factor de diseño 

$$
\mu1.=\mu2.
$$

El promedio del nivel 1 del factor rapidez es igual al promedio del nivel 2 del factor rapidez 

Sin tomar en cuenta el nivel de carbonatación. 

## Probar la hipótesis 

```{r}
f=cmrap/3.712
cmrap
cmres
anova(mod3)
pf(f,1,20,lower.tail = F)
```

Se encuentran diferencias en los promedios 

## Intervalo de confianza 


necesito el error estándar 

mu1.-mu2.=0

c(1,1,0,0)
c(1,-1,0,0)

```{r}
coef=mod3$coefficients
coef

vm1=c(1,1,0,0)
vm2=c(1,-1,0,0)
h=vm2-vm1

l=h%*%coef

ee=t(h)%*%vcov(mod3)%*%h
ee=sqrt(ee)
ee
```

Y un cuantil t

```{r}
t=qt(1-0.05,22)

```

La cota interior 

```{r}
l-ee*t
```

# Modelo con las tres interacciones triples 

```{r}
mod4=aov(d2~presion*rapidez+presion*carbonatacion+rapidez*carbonatacion,data = base)
anova(mod4)
```

## Observe los gl 

- Presion= a-1
- Rapidez= b-1
- Carbonatacion= 3-1
- pres:rap= (a-1)(b-1)
- pres:carb= (a-1)(c-1)
- rap:carb= (b-1)(c-1)

## Media var todos los trats

```{r}
vt=tapply(base$d2,list(base$rapidez,base$presion,base$carbonatacion),var)

mean(vt)
0.542
```

No coinciden porque uno toma en cuenta el efecto de la interacción triple, que hace falta... Por eso los promedios no coinciden 

## Model tables 

```{r}
model.tables(mod4)
```

# Evaluación de interacciones de primer orden 

Preguntar bien qué significa el drop1 y porque se hace

```{r}
drop1(mod4,test = "F") ## Se elimina presion y rapidez
mod4=aov(d2~presion*carbonatacion+rapidez*carbonatacion,data = base)

drop1(mod4,test = "F") ## Se elimina carbonatación y rapidez
mod4=aov(d2~presion*carbonatacion+rapidez,data = base)

drop1(mod4,test = "F") ## Ya no se elimina ninguno 
```

## Escriba el modelo final 

$$
\mu_{ijk}=\mu+\alpha_i+\beta_j+\nu_k+(\alpha \nu)_{ik}
$$

# Usando el modelo final haga las pruebas e intervalos de confianza pertinentes 

```{r}
rm(list = ls())
load("refrescos.Rdata")
base$carbonatacion=as.factor(base$carbonatacion)
base$presion=as.factor(base$presion)
base$rapidez=as.factor(base$rapidez)
```

```{r}
modf=aov(d2~rapidez+presion*carbonatacion,data = base)
anova(modf)
```

Preguntar porque 17 gl 

## Rapidez

Rapidez se puede analizar individualmente puesto que no tiene interacción con ninguna otra variable 

Se debe de probar la siguiente hipótesis, tomando en cuenta rapidez como el factor 1. 

Ya que rapidez solo tienen dos niveles 

$$
H0:\mu1..=\mu2..
$$

El contraste

mu1..-mu2..

Tenemos entonces los vectores para la media 

```{r}
coef=coef(modf);coef

r1pp=c(1,1,0,0,0,0,0)
r2pp=c(1,-1,0,0,0,0,0)

## El vector para el contraste 
h1=r2pp-r1pp ## Se ordenan de forma que nos de diferente. 

## El contraste 

l1=h1%*%coef;l1

```

En este caso no es necesario hacer ninguna prueba de hipótesis debido a que ya sabemos que si hay un efecto entre las dos medias. 

Podemos seguir con los intervalos 


Error estándar

```{r}
ee=sqrt(t(h1)%*%vcov(modf)%*%h1)
ee
```

Un cuantil de t 

```{r}
qt=qt(1-0.05,17)
```

Y la cota 

```{r}
l1-qt*ee
```


## Presion

Presión solo se puede analizar dentro de un nivel en especifico de carbonatación, asumiendo de presion es el factor 2 y carbonatacion el 3

Las hipotesis

mu.11=mu.21
 
También tengo que 

mu.12=mu.22

Y por último 

mu.13=mu.23


```{r}
coef

mp11=c(1,0,1,1,0,1,0)
mp21=c(1,0,-1,1,0,-1,0)

mp12=c(1,0,1,0,1,0,1)
mp22=c(1,0,-1,0,1,0,-1)

mp13=c(1,0,1,-1,-1,-1,-1)
mp23=c(1,0,-1,-1,-1,1,1)

## Las diferencias 

h2=mp11-mp21

h3=mp22-mp12

h4=mp23-mp13

## Los contrastes 

l2=h2%*%coef;l2
l3=h3%*%coef;l3
l4=h4%*%coef;l4

crossprod(h2,h3)
crossprod(h2,h4)
crossprod(h3,h4)
tapply(base$d2,list(base$))
```

Preguntar ortogonalidad 

Ahora puedo hacer las pruebas de hipótesis 

Necesito el error estándar 

```{r}
ee=sqrt(t(h2)%*%vcov(modf)%*%h2)


```


Necesito un estadístico t

```{r}
t2=l2/ee;t2
t3=l3/ee;t3
t4=l4/ee;t4

```

Y hacer la prueba 

```{r}
pt(t2,17,lower.tail = F)
pt(t3,17,lower.tail = F)
pt(t4,17,lower.tail = F)
```

Hay diferencias entre dos de los 3 pares 

Las cotas inferiores 

Necesito un cuantil t

```{r}
qt=qt(1-0.05/2,17)

```


```{r}
l3-qt*ee;l3+qt*ee
l4-qt*ee;l4+qt*ee

```



Preguntar modelos saturados 

Un modelo saturado es el que tiene todos los posibles elementos, con tres factores serían los efectos principales, int dobles e int triples. 



