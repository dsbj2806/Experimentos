---
title: "Burbujas"
author: "Daniel Sibaja Salazar"
date: "2024-05-30"
output: html_document
---

# Preparación 

## Cargue el archivo burbujas.Rdata

```{r}
load("burbujas.Rdata")
```

## Asegúrese que en todas las bases se han definido adecuadamente los factores glicerina, agua y nivel. 


```{r}
str(base1)
base1$glicerina=as.factor(base1$glicerina)
base1$persona=as.factor(base1$persona)

str(base2)
base2$glicerina=as.factor(base2$glicerina)
base2$persona=as.factor(base2$persona)


str(base3)
base3$glicerina=as.factor(base3$glicerina)
base3$persona=as.factor(base3$persona)
base3$nivel=as.factor(base3$nivel)

```

# Visualización de datos con glicerina 

## Realice la visualización usando base1


```{r}
library(ggplot2)

ggplot(base1,aes(x=persona,y=tiempo,group = glicerina))+
  stat_summary(fun = "mean",geom = "line",aes(linetype = glicerina))
```



## Observe si se puede esperar que haya diferencia entre las medias de los tratamientos.

Parece que la línea de glicerina 120 es mayor que la glicerina 60, sin embargo, parece que hay personas con valores más altos que los demás en ambos tratamientos y podría deberse al efecto del bloque. 

## Observe si hay alguna tendencia de valores más altos o más bajos para ciertas personas

Si, la persona 6 por ejemplo tiene los valores más altos de todos y la persona 6 los más bajos. 

## ¿Se observa interacción entre glicerina y persona?

Parece que en la persona 3 pero eso no debería de preocuparnos. 

## ¿Se podría verificar la hipótesis de no interacción?

No. 

## Centre los datos de tiempo dentro de cada persona, es decir, se quiere quitar el efecto del bloque restando la media del bloque al que una observación pertenece.

```{r}
modc=lm(tiempo~persona,data = base1)
fit=modc$fit

cent=base1$tiempo-fit+mean(base1$tiempo)

```

## Haga dos gráficos para ver la variabilidad del tiempo en los 2 niveles de glicerina: 1) use los datos originales, 2) use los tiempos centrados.

```{r}
boxplot(tiempo~glicerina,data = base1)
boxplot(cent~base1$glicerina,data = base1)
```


## Observe la variabilidad de los residuales en ambos gráficos. ¿A qué se deben las diferencias?

Se debe a que en uno tenemos la variabilidad de los bloques y en otra no la tenemos. Quiere decir que los bloques meten variabilidad. 

# 3. Varianza residual:

## Estime dos modelos: 1) uno incluyendo el factor de diseño y el bloque con el tiempo original como respuesta, 2) otro incluyendo sólo el factor de diseño con el tiempo centrado como respuesta.

```{r}
mod1=lm(base1$tiempo~base1$glicerina+base1$persona)
mod2=lm(cent~base1$glicerina)
```


## Compare los análisis de varianza de ambos modelos. Observe la suma de cuadrados total, la suma de cuadrados residual y los grados de libertad de ambos modelos.

```{r}
anova(mod1)
anova(mod2)
```

La suma de cuadrados es la misma, sin embargo los grados de libertad residuales del model sin bloques son el doble. 


## (c) ¿Cuál es la forma correcta de obtener la varianza residual?

Tomando en cuenta los bloques. 

## (d) Estime la varianza del error.

Necesito primero la suma de cuadrados de bloque 

```{r}
mb=tapply(base1$tiempo,base1$persona,mean)
mg=mean(base1$tiempo)
scbloque=sum(2*(mb-mg)^2)
cmbloque=scbloque/5
vg=tapply(base1$tiempo,base1$glicerina,var)
cmres=(sum(5*vg)-scbloque)/((12-1)-(2-1+6-1));cmres
```

## (e) ¿Qué representa esta varianza?

Representa la varianza dentro de los tratamientos una vez eliminado el efecto del bloque.

## Obtenga el valor de F para probar la hipótesis de igualdad de promedios entre los 2 niveles de glicerina. Calcule la probabilidad asociada con los grados de libertad adecuados. Concluya.

Necestio el CMTrat

```{r}
(mt=tapply(base1$tiempo,base1$glicerina,mean))
cmtrat=(sum(6*(mt-mg)^2))/1
cmtrat
table(base1$glicerina)
```

Ahora calculo la F

```{r}
f=cmtrat/cmres;f

pf(f,1,((12-1)-(2-1+6-1)),lower.tail = F)
```

Se rechaza la hipótesis de igualdad de medias para los tratamientos de glicerina. 


# 4. Modelo mixto:

## Para ilustrar la aplicación del modelo mixto, se ajusta el modelo con la función lme de la librería nlme. Escriba el modelo el cual se plantea de forma similar al modelo lineal, pero se separa el término aleatorio (bloque o persona) en el argumento random, y se pone de la siguiente forma: lme(Y X,random= 1|bloque, data = base).


```{r}
#install.packages("nlme")
library(nlme)
modm1=lme(tiempo~glicerina, random = ~1|persona,data = base1)

```

##  Obtenga el análisis de varianza con la función anova. Obtenga la probabilidad asociada a glicerina y compárela con la obtenida anteriormente.

```{r}
anova(modm1);anova(mod1);anova(mod2)
```

Se ven iguales. 


## Existe otra librería muy utilizada para el análisis de modelos mixtos que se llama lme4. Se usa la función lme4 y el modelo se plantea de la siguiente forma: lme4(Y X+(1|bloque),data=base. Escriba el modelo con esta función.

```{r}
#install.packages("lme4",type = "source")
library(lme4)
modm2=lmer(tiempo~glicerina+(1|persona),data = base1)
```


## Obtenga el summary. Observe que el resultado no da una probabilidad, sino que da un valor de t, para el cual debe buscarse la probabilidad asociada con los grados de libertad residuales. Obtenga la probabilidad con dos colas y compárela con la obtenida anteriormente.

```{r}
summary(modm2)
t=3.379
pt(t,((12-1)-(2-1+6-1)),lower.tail = F)*2
```

# 5. Homocedasticidad:

## Verifique el supuesto de homocedasticidad. No se pueden usar los tiempos originales puesto que debe considerarse la presencia de los bloques. La homocedasticidad es un supuesto que dice que la varianza condicional de la respuesta para cada tratamiento es la misma, lo cual implica que también los errores de los diferentes tratamientos tengan la misma varianza. En este caso, se recomienda obtener los residuales del modelo con bloques y luego hacer la prueba sobre estos residuales con el factor de la siguiente forma: bartlett.test(mod2$res~glicerina)

```{r}
anova(mod1)
bartlett.test(mod1$residuals~base1$glicerina)
```

No se rechaza la hipótesis. 


# 6. Análisis con glicerina y agua:

##  Use base2. Visualice los datos. Como se trata de dos factores se pueden centrar los datos por bloque y hacer un boxplot con ambos factores. Para esto se incluyen los factores separados por +. Haga un gráfico con los datos centrados como respuesta y ponga glicerina+agua, y otro gráfico poniendo agua+glicerina.


```{r}
modc2=lm(tiempo~persona,data = base2)
fit2=modc2$fit
rc2=base2$tiempo-fit2+mean(base1$tiempo)

boxplot(rc2~base2$glicerina+base2$agua)
boxplot(rc2~base2$agua+base2$glicerina)
```

## Analice si existe interacción entre glicerina y agua tanto gráficamente como con una prueba formal.

```{r}
ggplot(base2,aes(x=agua,y=tiempo,group = glicerina))+
  stat_summary(fun = "mean",geom = "line",aes(linetype = glicerina))
```


Parece que si hay interacción visto de forma gráfica. 


Prueba formal:

```{r}
mod3=lm(tiempo~glicerina*agua+persona,data = base2)
anova(mod3)
```


Se rechaza la hipótesis nula de interacción. 


## (c) Pruebe si hay efecto de la glicerina en este nuevo diseño, asumiendo que no hay interacción.

```{r}
options(contrasts = c("contr.sum","contr.poly"))
mod4=lm(tiempo~glicerina+agua+persona,data = base2)
anova(mod4)
```

Si hay efecto de glicerina. 

A mano.

CMTrat

```{r}
mgl=tapply(base2$tiempo,base2$glicerina,mean)
mg=mean(base2$tiempo)
sum(table(base2$persona))
cmtrat=sum(18*(mgl-mg)^2) ## Por qué 18? Agarra las replicas pero en la presentación la CMTrat para bloques es diferente
cmtrat
table(base2$glicerina)

```




## (d) Cuantifique la diferencia con un nivel de confianza de 95%.

Primero necesito los contrastes 

$$
\mu_1-\mu_2
$$

Tengo los coeficientes 

```{r}
coef4=mod4$coef
coef4
```


```{r}
v1=c(1,1,0,0,0,0,0,0,0)
v2=c(1,-1,0,0,0,0,0,0,0)
dif=v2-v1

l=dif%*%coef4

l
```

El error estándar 

```{r}
ee=sqrt(t(dif)%*%vcov(mod4)%*%dif)
```

Y un cuantil t

```{r}
(nrow(base2)-1)-(6-1+6-1)
t=qt(1-0.05,27) ## Preguntar grados de libertad 
```

Los intervalos 

```{r}
l-t*ee
l+t*ee

```

## (e) Pruebe si hay efecto del tipo de agua en este nuevo diseño.

```{r}
anova(mod4)
```

Si hay 

## Verifique entre cuáles pares de medias hay diferencias y cuantifique aquellas donde las diferencias son significativas. Use un nivel de signficancia de 5% y un nivel de confianza de 95%.

```{r}
table(base2$agua)
```

muA=muD
muA=muN
muD=muN

Con los contrastes 

muA-muD
muA-muN
muD-muN

```{r}
coef4
```


```{r}
vv1=c(1,0,1,0,0,0,0,0,0)
vv2=c(1,0,0,1,0,0,0,0,0)
vv3=c(1,0,-1,-1,0,0,0,0,0)

dd1=vv1-vv2;dd1
dd2=vv1-vv3;dd2
dd3=vv3-vv2;dd3

## Son ortogonales? No, tengo que hacer tukey

dd1%*%dd2
dd1%*%dd3
dd3%*%dd2


ll1=coef4%*%dd1
ll2=coef4%*%dd2
ll3=coef4%*%dd3


```


Los errores estándar


```{r}
est1=sqrt(t(dd1)%*%vcov(mod4)%*%dd1)
est2=sqrt(t(dd2)%*%vcov(mod4)%*%dd2)
est3=sqrt(t(dd3)%*%vcov(mod4)%*%dd3)
cmres4=25.26       

table(base2$agua)
eet=sqrt(cmres4*(1/12+1/12))
est1
```

Ahora hay que calcular el estadístico t

```{r}
et1=ll1/eet
et2=ll2/eet
et3=ll3/eet

```


Y las probabilidad asociadas 

```{r}
ptukey(et1*sqrt(2),3,27,lower.tail = F)
ptukey(et2*sqrt(2),3,27,lower.tail = F)
ptukey(et3*sqrt(2),3,27,lower.tail = F)

```

Se encuentran diferencias en las diferencias A D y AN 

Necesito el cuantil T

```{r}
qt1=qt(1-0.05/1,27) ## Por qué no sew hace bonferroni?


```

Y las cotas 

```{r}
ll1-qt1*eet
ll2-qt1*eet

```

# 7. Análisis con glicerina y nivel aeróbico:

Este experimento es de Parcelas divididas (?)

## (a) Haga un esquema del diseño.

Hecho a mano 

##  Haga el análisis para determinar si hay interacción entre glicerina y nivel usando la función lmer. Use la función drop1, con el parámetro |test=Çhisq"| que sirve para obtener la LRT.

```{r}
modp=lmer(tiempo~glicerina*nivel+(1|persona),data = base3)
drop1(modp,test = "Chisq")

```

No hay interacción. 

## Asumiendo que no hay interacción, determine si hay un efecto de la glicerina y del nivel de aeróbico.

```{r}
modp1=lmer(tiempo~glicerina+nivel+(1|persona),data = base3)
drop1(modp1,test = "Chisq")
```


No hay un efecto del nivel aeróbico pero si de glicerina. 








